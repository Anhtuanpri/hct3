<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Arena 90s ‚Äî Trung Thu Tech</title>
<style>
/* ===== THEME (Light default) ===== */
:root{
  --bg:#f6f7fb; --ink:#0f1230; --muted:#5b648a; --line:#0b0f2a18;
  --accent:#d08a00; --pink:#e84c88; --cyan:#0bbede; --vio:#7a56ff; --win:#2aa56e; --lose:#d44a63;
  --card1:#ffffffee; --card2:#f2f4ffcc; --arena1:#ffffffee; --arena2:#eef1ffcc; --ring:#e6e9f7; --badge:#f1f3ff;

  /* === SIZE / POSITION (ƒë√£ tƒÉng g·∫•p ƒë√¥i & nh√≠ch l√™n) === */
  --fighterSize:14px;
  --frameGrow:10px;     /* ‚¨ÜÔ∏è g·∫•p ƒë√¥i so v·ªõi b·∫£n tr∆∞·ªõc (28px) */
  --avatarInset:0px;    /* avatar √¥m s√°t ƒë·ªÉ khung ƒë√® */
  --frameOffsetY:-10px; /* ‚¨ÜÔ∏è nh√≠ch khung l√™n ch√∫t ƒë·ªÉ kh√¥ng th·∫•p */

  --frameScale1:1;
  --frameScale2:1;
}
[data-theme="dark"]{
  --bg:#0a0f1f; --ink:#e9efff; --muted:#aab3d7; --line:#ffffff22;
  --accent:#ffd166; --pink:#ff6b9b; --cyan:#38e1ff; --vio:#7c5cff; --win:#3ddc97; --lose:#ef476f;
  --card1:#1a2142aa; --card2:#121833bb; --arena1:#151c38bb; --arena2:#0c1233bb; --ring:#0d1433; --badge:#ffffff14;
}
body{margin:0;color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto;
  background:radial-gradient(1400px 600px at 70% 5%, #fff7 0%, var(--bg) 55%),linear-gradient(120deg,var(--bg) 0%, #f0f4ff 50%, var(--bg) 100%);
  min-height:100svh;overflow-x:hidden}
.container{max-width:1200px;margin:0 auto;padding:18px}
.header{display:flex;align-items:center;gap:12px;padding:20px 0 8px}
.logo{width:46px;height:46px;border-radius:14px;background:conic-gradient(from 210deg,#ffd166,#ff9a9e,#7c5cff,#38e1ff,#ffd166);box-shadow:0 10px 28px #0002,inset 0 0 30px #ffffff66}
.title{font-size:clamp(22px,3.6vw,34px);background:linear-gradient(90deg,#111,#333,#8c6a00,#222);-webkit-background-clip:text;background-clip:text;color:transparent;margin:0}
.subtitle{color:var(--muted)}
button{cursor:pointer;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:linear-gradient(180deg,#fff,#f2f4ff);color:#1a1e3a}
[data-theme="dark"] button{background:linear-gradient(180deg,#283069,#1a214a);color:#e9efff;border-color:#ffffff22}
.btn-primary{background:linear-gradient(180deg,#2f9964,#1f7b53);color:#fff;border:1px solid #3ddc9766}
.btn-ghost{background:linear-gradient(180deg,#fff,#f2f4ff)}
.btn-danger{background:linear-gradient(180deg,#c2516d,#8f2f43);color:#fff;border:1px solid #ef476f99}
.card{background:linear-gradient(180deg,var(--card1),var(--card2));border:1px solid var(--line);border-radius:18px;padding:14px;box-shadow:0 14px 40px #0001,inset 0 1px 0 #ffffff66;backdrop-filter:blur(6px)}
.grid{display:grid;gap:14px}
.lg-7{grid-column:span 7}.lg-5{grid-column:span 5}.lg-12{grid-column:span 12}
@media (max-width:950px){.lg-7,.lg-5{grid-column:span 12}}
label{font-size:13px;color:var(--muted)}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
input,textarea,select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #cfd6ff66;background:#fff;color:#1a1e3a;outline:none}
[data-theme="dark"] input,[data-theme="dark"] textarea,[data-theme="dark"] select{background:#101631;color:#e9efff;border-color:#2b355c}
textarea{min-height:64px;resize:vertical} input::placeholder,textarea::placeholder{color:#93a0d5aa}
.small{font-size:12px;color:var(--muted)}

/* tables */
table{width:100%;border-collapse:collapse;font-size:14px} th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left}
th{color:#3a4370;background:#eef1ff}[data-theme="dark"] th{color:#cfd7ff;background:#0e1430}
.tag{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;background:var(--badge);border:1px solid #cfd6ff66}

/* screens */
.screen{display:none;animation:fade .25s ease}.screen.active{display:block}
@keyframes fade{from{opacity:.5;transform:translateY(8px)}to{opacity:1;transform:none}}

/* ===== ARENA ===== */
.arenaCard{position:relative;border-radius:20px;padding:14px;background:linear-gradient(180deg,var(--arena1),var(--arena2));border:1px solid var(--line);box-shadow:0 14px 40px #0001,inset 0 1px 0 #ffffff66}
.arenaTop{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:10px}
.teamBox{display:flex;align-items:center;gap:10px}
.logoImg{width:44px;height:44px;border-radius:12px;object-fit:cover;border:1px solid var(--line);background:#fff}
.teamTitle{font-weight:800;letter-spacing:.3px}
.timerRing{--p:0deg;width:90px;height:90px;border-radius:50%;background:conic-gradient(#d08a00 var(--p), #d9e0ff 0deg);display:grid;place-items:center;
  box-shadow: inset 0 0 0 7px var(--ring), 0 0 0 1px #0001; color:#222; font-weight:900}
[data-theme="dark"] .timerRing{color:#fff}
.timerNum{font-size:18px}

/* square arena field */
.fieldWrap{position:relative;margin-top:10px;border-radius:14px;border:1px solid var(--line);background:#e9eefc;overflow:hidden}
[data-theme="dark"] .fieldWrap{background:#0b1231}
.field{position:relative;width:100%;aspect-ratio:1/1;overflow:hidden}
#arenaGif{position:absolute;inset:0;object-fit:cover;width:100%;height:100%;opacity:.22;pointer-events:none;mix-blend-mode:multiply}

/* fighter sprite (stacking context) */
.fighter{
  position:absolute;
  width:var(--fighterSize);height:var(--fighterSize);
  transform:translate(-50%,-50%);
  pointer-events:none;
  z-index:1;
}
.fAvatar{
  position:absolute;
  inset:var(--avatarInset);
  border-radius:50%;
  overflow:hidden;
  border:3px solid #ffffff;
  box-shadow:0 6px 18px #0003;
  z-index:2; /* avatar d∆∞·ªõi */
}
.fAvatar img{width:100%;height:100%;object-fit:cover;display:block}

/* FRAME OVERLAY ‚Äî khung to & ƒë√® l√™n avatar */
.fFrame{
  position:absolute;
  inset:calc(var(--frameGrow) * -1);
  pointer-events:none;
  display:grid;
  place-items:center;
  transform: translateY(var(--frameOffsetY)); /* √¢m = nh√≠ch l√™n */
  z-index:3; /* khung tr√™n avatar */
}
.fFrame img{
  width:100%;height:100%;object-fit:cover;
  transform: scale(var(--frameScale,1));
  transform-origin:center; image-rendering:auto;
}
/* team-specific scale hook */
.fighter.t1{ --frameScale: var(--frameScale1) }
.fighter.t2{ --frameScale: var(--frameScale2) }

.hpBar{position:absolute;left:50%;top:-12px;transform:translateX(-50%);width:66px;height:8px;border-radius:999px;background:#00000022;box-shadow:inset 0 1px 2px #0002}
.hpBar>span{display:block;height:100%;border-radius:999px;background:linear-gradient(90deg,#2aa56e,#7a56ff);width:100%;box-shadow:0 0 10px #2aa56e66}
.dead .fAvatar{filter:grayscale(1) brightness(.7);opacity:.6}
.dead .hpBar{opacity:.25}

/* Hit FX */
.spark{position:absolute;width:12px;height:12px;border-radius:50%;background:radial-gradient(#fff,#ff6b6b);opacity:.9;pointer-events:none;animation:spark .45s ease-out forwards}
@keyframes spark{to{transform:translate(var(--dx),var(--dy)) scale(.6);opacity:0}}
.slash{position:absolute;width:120px;height:26px;border-radius:999px;
  background:linear-gradient(90deg,transparent, #fff 25%, #ffd166 50%, #ff6b6b 75%, transparent);
  box-shadow:0 0 20px #fff6, 0 0 30px #ffd16655; mix-blend-mode:screen; pointer-events:none;
  transform:translate(-50%,-50%) rotate(0deg); opacity:.95; filter:blur(.2px); animation:slashOut .28s ease-out forwards}
@keyframes slashOut{to{transform:translate(-50%,-50%) rotate(var(--ang)) scaleX(1.35); opacity:0}}
.fighter.hit .fAvatar{filter:brightness(1.35) saturate(1.25) drop-shadow(0 6px 16px #fff6)}
.field.shake{animation:shake .12s linear 1}
@keyframes shake{
  0%{transform:translate(0,0)} 25%{transform:translate(2px,-1px)}
  50%{transform:translate(-2px,1px)} 75%{transform:translate(1px,2px)}
  100%{transform:translate(0,0)}
}

/* overlay countdown & dim at last 3s */
.overlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:radial-gradient(50% 80% at 50% 50%, #00000040, #00000055);backdrop-filter:blur(3px);z-index:5}
.overlay.show{display:flex}
.dimLast{position:absolute;inset:0;display:none;background:radial-gradient(50% 80% at 50% 50%, #00000026, #00000050);backdrop-filter:blur(2px);z-index:3}
.dimLast.show{display:block}

/* Popup k·∫øt qu·∫£ KH√îNG l√†m m·ªù s√†n */
.overlay.plain{background:transparent !important; backdrop-filter:none !important}

.calli{font-family:"Brush Script MT","Segoe Script","Zapfino","Snell Roundhand",cursive;letter-spacing:.5px;text-shadow:0 10px 40px #0006,0 0 10px #fff8}
.countNum{font-size:clamp(64px,10vw,140px);font-weight:900;background:linear-gradient(180deg,#111,#8c6a00,#e84c88);-webkit-background-clip:text;background-clip:text;color:transparent;animation:pop .6s ease}
@keyframes pop{from{transform:scale(.7);opacity:.5} to{transform:scale(1);opacity:1}}

/* Result card */
.resultCard{
  position:relative;background:linear-gradient(180deg,#ffffffee,#f4f6ffef);
  border:1px solid #00000010;border-radius:22px;padding:18px;width:min(520px,92vw);
  box-shadow:0 28px 80px #0003, inset 0 1px 0 #ffffffaa;color:#111
}
[data-theme="dark"] .resultCard{background:linear-gradient(180deg,#12183aee,#0c1233ee);color:#fff;border-color:#ffffff2a}
.resultTitle{margin:0 0 8px;font-size:clamp(20px,3.2vw,28px);
  background:linear-gradient(90deg,#0f1230,#8c6a00,#e84c88);-webkit-background-clip:text;background-clip:text;color:transparent}
.resultMeta{font-size:13px;color:#586099}

/* tables under lobby */
.maxh{max-height:320px;overflow:auto}
</style>
</head>
<body>
<div class="container" id="root" data-theme="light">
  <div class="header">
    <div class="logo"></div>
    <div>
      <h1 class="title">üéë Arena 90s ‚Äî ƒê√°nh Nhau Tr√∫ng Xu</h1>
      <div class="subtitle">Khung to g·∫•p ƒë√¥i & ƒë√® l√™n avatar, nh√≠ch cao h∆°n; di chuy·ªÉn nhanh; hi·ªáu ·ª©ng ch√©m/spark/rung. Popup th·∫Øng kh√¥ng m·ªù n·ªÅn.</div>
    </div>
    <button id="toggleTheme">üåó Dark/Light</button>
  </div>

  <!-- ===== LOBBY ===== -->
  <section id="screenLobby" class="screen active">
    <div class="grid" style="grid-template-columns:repeat(12,1fr)">
      <div class="card lg-7">
        <h2>‚öôÔ∏è Thi·∫øt l·∫≠p</h2>
        <div class="row">
          <div>
            <label>Nh·∫≠p t·∫•t c·∫£ ID (ph√¢n c√°ch d·∫•u ph·∫©y ho·∫∑c xu·ªëng d√≤ng)</label>
            <textarea id="allIds" placeholder="vd: 101, 102, 103, 201, 202, 203"></textarea>
          </div>
          <div>
            <label>Random Teams (t√πy ch·ªçn)</label>
            <div class="row">
              <button id="btnRandom" class="btn-ghost">üé≤ Random Teams</button><div></div>
            </div>
            <div class="small">Sau khi b·∫•m, 2 √¥ b√™n d∆∞·ªõi s·∫Ω ƒë∆∞·ª£c l·∫•p ID.</div>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div><label>ƒê·ªôi 1 ‚Äî ID</label><textarea id="team1" placeholder="vd: 101, 102, 103"></textarea></div>
          <div><label>ƒê·ªôi 2 ‚Äî ID</label><textarea id="team2" placeholder="vd: 201, 202, 203"></textarea></div>
        </div>

        <div class="row" style="margin-top:10px">
          <div><label>Avatar ƒê·ªôi 1 (URL)</label><input id="ava1" placeholder="https://.../team1_avatar.png"></div>
          <div><label>Avatar ƒê·ªôi 2 (URL)</label><input id="ava2" placeholder="https://.../team2_avatar.png"></div>
        </div>

        <div class="row" style="margin-top:10px">
          <div><label>Khung ƒê·ªôi 1 (APNG/GIF/PNG/JPG)</label><input id="frameUrl1" placeholder="https://.../frame_team1.png"></div>
          <div><label>Khung ƒê·ªôi 2 (APNG/GIF/PNG/JPG)</label><input id="frameUrl2" placeholder="https://.../frame_team2.png"></div>
        </div>

        <div class="row" style="margin-top:10px">
          <div><label>GIF s√†n ƒë·∫•u (t√πy ch·ªçn)</label><input id="arenaGifUrl" placeholder="https://.../arena.gif"></div>
          <div>
            <label>Scale frame ph·ª• (n·∫øu c·∫ßn tinh ch·ªânh)</label>
            <div class="row" style="grid-template-columns:1fr 1fr; gap:8px">
              <input id="frameScale1" type="number" step="0.05" value="1.00" title="ƒê·ªôi 1">
              <input id="frameScale2" type="number" step="0.05" value="1.00" title="ƒê·ªôi 2">
            </div>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div><label>Logo ƒê·ªôi 1</label><input id="logo1" placeholder="https://.../logo1.png"></div>
          <div><label>Logo ƒê·ªôi 2</label><input id="logo2" placeholder="https://.../logo2.png"></div>
        </div>

        <div class="row" style="margin-top:10px">
          <div><label>Ti·ªÅn th∆∞·ªüng m·ªói tr·∫≠n (xu)</label><input id="reward" type="number" min="1" step="1" value="100"></div>
          <div><label>Th·ªùi l∆∞·ª£ng tr·∫≠n (gi√¢y)</label><input id="duration" type="number" min="10" step="5" value="90"></div>
        </div>

        <div class="row" style="margin-top:12px">
          <button id="btnStart" class="btn-primary">üöÄ Start ‚Äî V√†o Arena</button>
          <button id="btnClear" class="btn-danger">‚ôªÔ∏è X√≥a d·ªØ li·ªáu</button>
        </div>
      </div>

      <div class="card lg-5">
        <h2>üìä B·∫£ng t·ªïng (theo ID)</h2>
        <div class="row" style="grid-template-columns:1fr auto;align-items:center">
          <div class="small">T·ª± c·∫≠p nh·∫≠t sau m·ªói tr·∫≠n. Chia xu <b>ƒë·ªÅu</b>.</div>
          <button id="btnExport" class="btn-ghost">‚¨áÔ∏è Xu·∫•t CSV</button>
        </div>
        <div class="maxh" style="margin-top:10px">
          <table id="leaderboard"><thead><tr><th>#</th><th>ID</th><th>Xu</th></tr></thead><tbody></tbody></table>
        </div>
      </div>

      <div class="card lg-12">
        <h2>üßæ L·ªãch s·ª≠ tr·∫≠n</h2>
        <div class="maxh" style="margin-top:10px">
          <table id="history"><thead><tr><th>Th·ªùi gian</th><th>ƒê·ªôi th·∫Øng</th><th>Th∆∞·ªüng</th><th>Ng∆∞·ªùi nh·∫≠n</th><th>T·ªïng ph√°t</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </div>
  </section>

  <!-- ===== ARENA ===== -->
  <section id="screenArena" class="screen">
    <div class="card arenaCard">
      <div class="arenaTop">
        <div class="teamBox">
          <img id="logoImg1" class="logoImg" alt="" hidden>
          <div><div class="teamTitle">ƒê·ªôi 1 <span id="count1" class="small"></span></div><div class="small">Avatars chi·∫øn h·ªØu</div></div>
        </div>
        <div class="timerRing" id="timerRing"><div class="timerNum" id="timerText">90</div></div>
        <div class="teamBox" style="justify-self:end">
          <div style="text-align:right"><div class="teamTitle">ƒê·ªôi 2 <span id="count2" class="small"></span></div><div class="small">Avatars chi·∫øn h·ªØu</div></div>
          <img id="logoImg2" class="logoImg" alt="" hidden>
        </div>
      </div>

      <div class="fieldWrap">
        <div class="field" id="field">
          <img id="arenaGif" alt="" hidden>
          <div class="dimLast" id="dimLast"></div>
          <!-- overlay d√πng chung: countdown (m·ªù) & popup th·∫Øng (plain) -->
          <div class="overlay" id="overlay"><div id="overlayInner"></div></div>
        </div>
      </div>
    </div>
    <div style="display:flex;gap:10px;margin-top:12px">
      <button id="btnBack" class="btn-ghost">‚üµ Tr·ªü v·ªÅ Lobby</button>
    </div>
  </section>
</div>

<script>
/* ====== CONFIG (m·∫∑c ƒë·ªãnh n·∫øu kh√¥ng nh·∫≠p tr√™n UI) ====== */
const ASSETS_DEFAULT = {
  avatar1: 'https://picsum.photos/seed/team1/128',
  avatar2: 'https://picsum.photos/seed/team2/128',
  frame1:  '',
  frame2:  '',
  arenaGif: '',
  logo1: '', logo2: ''
};

/* ====== Helpers ====== */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const dist2 = (x1,y1,x2,y2)=>{const dx=x2-x1,dy=y2-y1;return dx*dx+dy*dy;}
function parseIds(text){ return text? [...new Set(text.split(/[,\s]+/).map(s=>s.trim()).filter(Boolean))] : []; }
function nowStr(){ const d=new Date(),p=n=>String(n).padStart(2,'0'); return `${p(d.getDate())}/${p(d.getMonth()+1)}/${d.getFullYear()} ${p(d.getHours())}:${p(d.getMinutes())}`; }
function download(filename, text){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([text],{type:'text/csv;charset=utf-8;'})); a.download=filename; a.click(); URL.revokeObjectURL(a.href); }

/* ====== Persistent totals/history ====== */
const KEY='arena90_totals_v1';
let state={ totals:{}, history:[] };
try{ const raw=localStorage.getItem(KEY); if(raw){ state=JSON.parse(raw) || state; } }catch(e){}
function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }
function renderLeaderboard(){
  const tbody=$('#leaderboard tbody'); tbody.innerHTML='';
  const rows=Object.entries(state.totals).map(([id,coins])=>({id,coins})).sort((a,b)=>b.coins-a.coins);
  rows.forEach((r,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${i+1}</td><td><span class="tag">${r.id}</span></td><td><b>${r.coins.toFixed(2)}</b></td>`; tbody.appendChild(tr); });
}
function renderHistory(){
  const tbody=$('#history tbody'); tbody.innerHTML='';
  state.history.slice().reverse().forEach(h=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${h.time}</td><td>${h.winner===1?'ƒê·ªôi 1':'ƒê·ªôi 2'}</td><td>${h.reward}</td><td>${h.recipients}</td><td>${h.distributed?.toFixed? h.distributed.toFixed(2): h.distributed||0}</td>`;
    tbody.appendChild(tr);
  });
}

/* ====== Theme toggle ====== */
$('#toggleTheme').addEventListener('click', ()=>{
  const root = document.getElementById('root');
  root.dataset.theme = (root.dataset.theme === 'dark') ? 'light' : 'dark';
});

/* ====== Random Teams ====== */
$('#btnRandom').addEventListener('click', ()=>{
  const all=parseIds($('#allIds').value);
  if(all.length<2){ alert('C·∫ßn √≠t nh·∫•t 2 ID ƒë·ªÉ chia team.'); return; }
  for(let i=all.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [all[i],all[j]]=[all[j],all[i]]; }
  const mid=Math.ceil(all.length/2);
  $('#team1').value = all.slice(0,mid).join(', ');
  $('#team2').value = all.slice(mid).join(', ');
});

/* ====== Export & Clear ====== */
$('#btnExport').addEventListener('click', ()=>{
  const rows=Object.entries(state.totals).map(([id,coins])=>({id,coins})).sort((a,b)=>b.coins-a.coins);
  let csv='ID,Coins\n'; rows.forEach(r=> csv+=`${r.id},${r.coins.toFixed(2)}\n`);
  download('leaderboard_totals.csv', csv);
});
$('#btnClear').addEventListener('click', ()=>{
  if(!confirm('X√≥a to√†n b·ªô leaderboard & l·ªãch s·ª≠?')) return;
  state={totals:{}, history:[]}; save(); renderLeaderboard(); renderHistory();
});

/* ====== Screens ====== */
function show(id){ $$('.screen').forEach(s=>s.classList.remove('active')); $(id).classList.add('active'); }

/* ====== Arena Simulation ====== */
const field = $('#field');
const overlay = $('#overlay');
const overlayInner = $('#overlayInner');
const dimLast = $('#dimLast');
const timerRing = $('#timerRing');
const timerText = $('#timerText');
const arenaGif = $('#arenaGif');

let sim = { acc: 0, raf: null, running: false };

function evenSplit(total, n){
  if(n<=0) return [];
  const base = Math.floor((total/n)*100)/100;
  const arr = Array(n).fill(base);
  let used = +(base*n).toFixed(2);
  let remain = +(total - used).toFixed(2);
  let i=0;
  while(remain>0 && i<10000){
    const step = Math.min(0.01, remain);
    arr[i % n] = +(arr[i % n] + step).toFixed(2);
    remain = +(remain - step).toFixed(2); i++;
  }
  return arr;
}

/* Countdown (c√≥ n·ªÅn m·ªù) */
function showOverlayCountdown(seq, cb){
  overlay.classList.remove('plain');
  overlay.classList.add('show'); overlayInner.innerHTML='';
  let i=0; (function next(){
    if(i>=seq.length){ overlay.classList.remove('show'); cb(); return; }
    overlayInner.innerHTML = `<div class="countNum calli">${seq[i++]}</div>`;
    setTimeout(next, 600);
  })();
}

function setTimer(total, left){
  timerText.textContent = left;
  const deg = (1 - left/total) * 360;
  timerRing.style.setProperty('--p', `${deg}deg`);
}

/* FX helpers */
function spark(x,y,count=6,spread=50){
  for(let k=0;k<count;k++){
    const s=document.createElement('div'); s.className='spark';
    s.style.left=x+'px'; s.style.top=y+'px';
    s.style.setProperty('--dx', (Math.random()*spread-spread/2)+'px');
    s.style.setProperty('--dy', (Math.random()*spread-spread/2)+'px');
    field.appendChild(s); setTimeout(()=>s.remove(), 450);
  }
}
function slash(x,y,angRad){
  const sl=document.createElement('div'); sl.className='slash';
  sl.style.left=x+'px'; sl.style.top=y+'px';
  const deg = (angRad*180/Math.PI).toFixed(2)+'deg';
  sl.style.setProperty('--ang', deg);
  field.appendChild(sl); setTimeout(()=>sl.remove(), 280);
}
function shakeField(ms=120){ field.classList.add('shake'); setTimeout(()=>field.classList.remove('shake'), ms); }

/* Fighter */
function createFighter({id, team, x, y, avatarUrl, frameUrl}){
  const el=document.createElement('div'); el.className='fighter t'+team;
  el.style.left=`${x}px`; el.style.top=`${y}px`; el.dataset.team=team; el.dataset.id=id;

  const hpWrap=document.createElement('div'); hpWrap.className='hpBar';
  const hpInner=document.createElement('span'); hpWrap.appendChild(hpInner);

  const avatar=document.createElement('div'); avatar.className='fAvatar';
  const img=document.createElement('img'); img.src=avatarUrl; avatar.appendChild(img);

  const frame=document.createElement('div'); frame.className='fFrame';
  if(frameUrl){ const fimg=document.createElement('img'); fimg.src=frameUrl; frame.appendChild(fimg); }

  el.appendChild(hpWrap); el.appendChild(avatar); el.appendChild(frame); field.appendChild(el);

  return { id, team, x, y, vx:(Math.random()*.6+.4)*(Math.random()<.5?1:-1), vy:(Math.random()*.6+.4)*(Math.random()<.5?1:-1),
           hp:100, maxHp:100, alive:true, el, hpInner, radius:28, atkCd:0 };
}

/* Start battle */
function startBattle(opts){
  if(sim && sim.raf) cancelAnimationFrame(sim.raf);
  sim = { acc: 0, raf: null, running: true };

  $$('.fighter').forEach(n=>n.remove());
  dimLast.classList.remove('show');

  const rect = field.getBoundingClientRect();
  const W = rect.width, H = rect.height;

  const fighters=[];
  const pad=60;
  const spread = (n, leftSide)=> Array.from({length:n}, ()=>({
    x: leftSide? (pad + Math.random()*(W*0.35-pad)) : (W - pad - Math.random()*(W*0.35-pad)),
    y: pad + Math.random()*(H - pad*2)
  }));

  const pos1=spread(opts.team1.length, true);
  const pos2=spread(opts.team2.length, false);

  opts.team1.forEach((id,i)=>{
    fighters.push( createFighter({id, team:1, x:pos1[i].x, y:pos1[i].y, avatarUrl:opts.avatar1, frameUrl:opts.frame1}) );
  });
  opts.team2.forEach((id,i)=>{
    fighters.push( createFighter({id, team:2, x:pos2[i].x, y:pos2[i].y, avatarUrl:opts.avatar2, frameUrl:opts.frame2}) );
  });

  // apply frame scale from UI
  document.documentElement.style.setProperty('--frameScale1', String(opts.frameScale1||1));
  document.documentElement.style.setProperty('--frameScale2', String(opts.frameScale2||1));

  const totalTime = opts.duration;
  let left = totalTime;
  let lastTs = performance.now();

  function step(ts){
    const dt = Math.min(0.033, (ts - lastTs)/1000);
    lastTs = ts;

    sim.acc += dt;
    if(sim.acc >= 1){
      sim.acc -= 1;
      left = Math.max(0, left-1);
      setTimer(totalTime, left);
      if(left<=3 && left>0){ dimLast.classList.add('show'); showCornerCountdown(left); }
      if(left>3){ dimLast.classList.remove('show'); hideCornerCountdown(); }
    }

    const alive1=fighters.filter(f=>f.alive&&f.team===1);
    const alive2=fighters.filter(f=>f.alive&&f.team===2);

    if(alive1.length===0 || alive2.length===0 || left<=0){
      endBattle({fighters, winner: decideWinner(alive1, alive2, left), reward: opts.reward});
      return;
    }

    fighters.forEach(f=>{
      if(!f.alive) return;
      const enemies = f.team===1? alive2 : alive1;
      if(enemies.length===0) return;

      // nearest target
      let target=enemies[0], best=Infinity;
      for(const e of enemies){ const d2=dist2(f.x,f.y,e.x,e.y); if(d2<best){best=d2;target=e;} }
      const dx=target.x - f.x, dy=target.y - f.y;
      const d=Math.hypot(dx,dy)||1; const nx=dx/d, ny=dy/d;

      // separation
      const allies = f.team===1? alive1 : alive2;
      let sx=0, sy=0;
      for(const a of allies){
        if(a===f || !a.alive) continue;
        const d2a=dist2(f.x,f.y,a.x,a.y);
        if(d2a<70*70){ const dA=Math.sqrt(d2a)||1; sx += (f.x - a.x)/dA; sy += (f.y - a.y)/dA; }
      }

      /* ===== SPEED TUNING ===== */
      const speed = 140 + Math.random()*60; // px/s
      f.vx += (nx*0.9 + sx*0.4) * dt * 40;
      f.vy += (ny*0.9 + sy*0.4) * dt * 40;
      const vmax = speed, vlen = Math.hypot(f.vx,f.vy) || 1;
      f.vx = f.vx/vlen * vmax; f.vy = f.vy/vlen * vmax;

      // move + bounds
      f.x += f.vx*dt; f.y += f.vy*dt;
      const r = f.radius;
      if(f.x<r){f.x=r; f.vx*=-.8} if(f.x>W-r){f.x=W-r; f.vx*=-.8}
      if(f.y<r){f.y=r; f.vy*=-.8} if(f.y>H-r){f.y=H-r; f.vy*=-.8}

      // attack (d·ªÖ ch·∫°m h∆°n)
      const atkRange = 42;
      f.atkCd = Math.max(0, f.atkCd - dt);
      if(f.atkCd<=0 && d <= atkRange){
        const dmg = 8 + Math.random()*12;
        target.hp = Math.max(0, target.hp - dmg);
        target.hpInner.style.width = (target.hp/target.maxHp*100)+'%';
        // FX m·∫°nh
        const mx = (f.x+target.x)/2, my = (f.y+target.y)/2;
        slash(mx,my,Math.atan2(dy,dx));
        spark(mx,my,8,70);
        shakeField(120);
        target.el.classList.add('hit'); setTimeout(()=>target.el.classList.remove('hit'),120);

        f.atkCd = 0.45 + Math.random()*0.35;
        // knockback tƒÉng
        const kb = 28; target.vx += nx * kb; target.vy += ny * kb;

        if(target.hp<=0){ target.alive=false; target.el.classList.add('dead'); }
      }

      // paint
      f.el.style.left = f.x+'px'; f.el.style.top  = f.y+'px';
    });

    sim.raf = requestAnimationFrame(step);
  }

  showOverlayCountdown(['3','2','1','B·∫ÆT ƒê·∫¶U!'], ()=>{
    lastTs = performance.now();
    setTimer(totalTime, left);
    sim.raf = requestAnimationFrame(step);
  });
}

function showCornerCountdown(n){
  overlay.classList.add('show'); overlayInner.innerHTML = `<div class="countNum calli">${n}</div>`;
}
function hideCornerCountdown(){ overlay.classList.remove('show'); overlayInner.innerHTML=''; }

function decideWinner(alive1, alive2, left){
  if(alive1.length===0 && alive2.length>0) return 2;
  if(alive2.length===0 && alive1.length>0) return 1;
  if(left<=0){
    if(alive1.length>alive2.length) return 1;
    if(alive2.length>alive1.length) return 2;
    const hp1 = alive1.reduce((s,f)=>s+f.hp,0);
    const hp2 = alive2.reduce((s,f)=>s+f.hp,0);
    if(hp1>hp2) return 1; if(hp2>hp1) return 2;
  }
  return Math.random()<0.5?1:2;
}

/* Popup k·∫øt th√∫c: plain, kh√¥ng m·ªù n·ªÅn, kh√¥ng hi·ªán chia xu */
function endBattle({fighters, winner, reward}){
  if(sim && sim.raf){ cancelAnimationFrame(sim.raf); }
  sim.running = false; dimLast.classList.remove('show'); hideCornerCountdown();

  const winners = fighters.filter(f=>f.team===winner);
  const ids = winners.map(f=>f.id);
  state.history.push({ time:nowStr(), winner, reward, recipients:ids.length, distributed:reward });
  save(); renderLeaderboard(); renderHistory();

  overlay.classList.add('plain');
  overlay.classList.add('show');
  overlayInner.innerHTML = `
    <div class="resultCard">
      <h2 class="resultTitle">üéâ ƒê·ªôi <span style="filter:drop-shadow(0 4px 12px #ffd16666); color:${winner===1?'#0bbede':'#e84c88'}">${winner}</span> chi·∫øn th·∫Øng!</h2>
      <div class="resultMeta">Ch√∫c m·ª´ng! B·∫•m V·ªÅ Lobby ƒë·ªÉ ti·∫øp t·ª•c.</div>
      <div style="display:flex; gap:10px; margin-top:14px; justify-content:flex-end">
        <button id="btnNext" class="btn-primary">‚üµ V·ªÅ Lobby</button>
      </div>
    </div>`;
  $('#btnNext').onclick = ()=>{ overlay.classList.remove('show','plain'); show('#screenLobby'); };
}

/* ====== Wiring ====== */
renderLeaderboard(); renderHistory();

$('#btnStart').addEventListener('click', ()=>{
  const team1 = parseIds($('#team1').value);
  const team2 = parseIds($('#team2').value);
  if(team1.length===0 || team2.length===0){ alert('C·∫ßn nh·∫≠p ID cho c·∫£ 2 ƒë·ªôi.'); return; }
  if(team1.some(id=>team2.includes(id))){ alert('M·ªôt ID kh√¥ng th·ªÉ thu·ªôc c·∫£ hai ƒë·ªôi.'); return; }

  const reward = Math.max(1, Math.floor(Number($('#reward').value)||0));
  const duration = Math.max(10, Math.floor(Number($('#duration').value)||90));

  const avatar1 = ($('#ava1').value.trim() || ASSETS_DEFAULT.avatar1);
  const avatar2 = ($('#ava2').value.trim() || ASSETS_DEFAULT.avatar2);
  const frame1  = ($('#frameUrl1').value.trim() || ASSETS_DEFAULT.frame1);
  const frame2  = ($('#frameUrl2').value.trim() || ASSETS_DEFAULT.frame2);

  const frameScale1 = parseFloat($('#frameScale1').value)||1;
  const frameScale2 = parseFloat($('#frameScale2').value)||1;

  const gifUrl   = ($('#arenaGifUrl').value.trim() || ASSETS_DEFAULT.arenaGif);
  const l1 = ($('#logo1').value.trim() || ASSETS_DEFAULT.logo1);
  const l2 = ($('#logo2').value.trim() || ASSETS_DEFAULT.logo2);

  // logos
  const L1=$('#logoImg1'), L2=$('#logoImg2');
  if(l1){ L1.src=l1; L1.hidden=false; } else { L1.hidden=true; }
  if(l2){ L2.src=l2; L2.hidden=false; } else { L2.hidden=true; }

  // arena gif
  if(gifUrl){ arenaGif.src=gifUrl; arenaGif.hidden=false; } else { arenaGif.removeAttribute('src'); arenaGif.hidden=true; }

  $('#count1').textContent = `(${team1.length} ID)`; $('#count2').textContent = `(${team2.length} ID)`;
  show('#screenArena');

  showOverlayCountdown(['3','2','1','B·∫ÆT ƒê·∫¶U!'], ()=>{
    startBattle({ team1, team2, avatar1, avatar2, frame1, frame2, frameScale1, frameScale2, duration, reward });
  });
});

$('#btnBack').addEventListener('click', ()=>{
  if(sim && sim.raf){ if(!confirm('Tr·∫≠n c√≥ th·ªÉ ƒëang di·ªÖn ra. Tho√°t v·ªÅ Lobby?')) return; cancelAnimationFrame(sim.raf); }
  overlay.classList.remove('show','plain'); dimLast.classList.remove('show'); show('#screenLobby');
});
</script>
</body>
</html>
